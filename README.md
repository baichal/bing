# å¾®è½¯ Bing å¿…åº”ç§¯åˆ†è‡ªåŠ¨è„šæœ¬ä½¿ç”¨æŒ‡å—

**ç‰ˆæœ¬:** 2025.12.22.10  
**é€‚ç”¨æµè§ˆå™¨:** Chrome, Edge, Firefox (éœ€å®‰è£… Tampermonkey æ‰©å±•)

---

## âš ï¸ å…è´£å£°æ˜ (Disclaimer)

**è¯·åœ¨ä¸‹è½½å’Œä½¿ç”¨æœ¬è„šæœ¬å‰ä»”ç»†é˜…è¯»ä»¥ä¸‹æ¡æ¬¾ï¼š**

1.  **ä»…ä¾›å­¦ä¹ äº¤æµ**ï¼šæœ¬è„šæœ¬ç¼–å†™çš„åˆè¡·ä»…ä¸ºäº†éªŒè¯æµè§ˆå™¨è‡ªåŠ¨åŒ–æŠ€æœ¯ä¸å‰ç«¯é¡µé¢äº¤äº’é€»è¾‘ï¼Œ**ä¸¥ç¦ç”¨äºä»»ä½•å•†ä¸šç”¨é€”**æˆ–é€šè¿‡æ­¤è„šæœ¬è¿›è¡Œéæ³•è·åˆ©ã€‚
2.  **é£é™©è‡ªè´Ÿ**ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–å·¥å…·åˆ·å–ç§¯åˆ†è¿åäº† Microsoft Rewards çš„æœåŠ¡æ¡æ¬¾ (ToS)ã€‚å¾®è½¯æ‹¥æœ‰å…ˆè¿›çš„æ£€æµ‹æœºåˆ¶ï¼Œ**ä½¿ç”¨æœ¬è„šæœ¬å¯èƒ½ä¼šå¯¼è‡´æ‚¨çš„ç§¯åˆ†è¢«æ¸…é›¶ã€å…‘æ¢åŠŸèƒ½è¢«å°ç¦ï¼Œç”šè‡³ Microsoft è´¦å·è¢«æ°¸ä¹…å°ç¦ã€‚**
3.  **æ— æ‹…ä¿**ï¼šä½œè€…ä¸å¯¹è„šæœ¬çš„ç¨³å®šæ€§ã€å®‰å…¨æ€§æˆ–å› ä½¿ç”¨è„šæœ¬é€ æˆçš„ä»»ä½•æŸå¤±ï¼ˆåŒ…æ‹¬ä½†ä¸é™äºè´¦å·å°ç¦ã€æ•°æ®ä¸¢å¤±ï¼‰æ‰¿æ‹…è´£ä»»ã€‚
4.  **è‡ªä¸»é€‰æ‹©**ï¼šä¸€æ—¦æ‚¨å®‰è£…å¹¶å¯ç”¨äº†æœ¬è„šæœ¬ï¼Œå³ä»£è¡¨æ‚¨å®Œå…¨çŸ¥æ™“å¹¶æ„¿æ„æ‰¿æ‹…æ‰€æœ‰ç›¸å…³é£é™©ã€‚

---

## ğŸ› ï¸ åŠŸèƒ½ç‰¹æ€§

æœ¬è„šæœ¬ï¼ˆ2025.12.22.10ç‰ˆï¼‰é’ˆå¯¹å¿…åº”ç§¯åˆ†ç³»ç»Ÿè¿›è¡Œäº†æ·±åº¦ä¼˜åŒ–ï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬ï¼š

*   **æ™ºèƒ½æœç´¢åˆ·åˆ†**ï¼š
    *   è‡ªåŠ¨è·å–ä»Šæ—¥çƒ­æ¦œï¼ˆå¾®åšç­‰ï¼‰å…³é”®è¯è¿›è¡ŒçœŸå®æ„Ÿæœç´¢ã€‚
    *   æ¯æ—¥è‡ªåŠ¨éšæœºåˆ‡æ¢æ¦œå•ï¼Œé¿å…å•ä¸€è¡Œä¸ºæ¨¡å¼ã€‚
    *   **æ™ºèƒ½ç§¯åˆ†æ£€æµ‹**ï¼šå®æ—¶ç›‘æ§ç§¯åˆ†å˜åŒ–ï¼Œè‹¥è¿ç»­æœç´¢æ— ç§¯åˆ†å¢é•¿ï¼Œä¼šè‡ªåŠ¨åœæ­¢æˆ–å°è¯•æ¢é¡µï¼Œé˜²æ­¢æ— æ•ˆåˆ·åˆ†ã€‚
*   **æ¯æ—¥ä»»åŠ¡è‡ªåŠ¨åŒ–**ï¼š
    *   è‡ªåŠ¨è¯†åˆ«å¹¶ç‚¹å‡» Rewards é¡µé¢çš„æ¯æ—¥ä»»åŠ¡å¡ç‰‡ï¼ˆæµ‹è¯•ã€æŠ•ç¥¨ç­‰ï¼‰ã€‚
    *   æ”¯æŒä»»åŠ¡å»é‡å’Œé»‘åå•æœºåˆ¶ï¼Œè·³è¿‡å¡æ­»çš„ä»»åŠ¡ã€‚
*   **é˜²å°ä¸ç¨³å®šæ€§**ï¼š
    *   **éšæœºå»¶è¿Ÿ**ï¼šæœç´¢é—´éš”é‡‡ç”¨ 8-14ç§’ éšæœºå»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸäººæ“ä½œã€‚
    *   **å¤šæ ‡ç­¾é¡µäº’æ–¥**ï¼šé˜²æ­¢åœ¨å¤šä¸ªå¿…åº”é¡µé¢åŒæ—¶è¿è¡Œè„šæœ¬å¯¼è‡´å†²çªã€‚
    *   **é˜²æ­»å¾ªç¯**ï¼šå†…ç½®ç†”æ–­æœºåˆ¶ï¼Œè¿ç»­å¤šæ¬¡æ— æ”¶ç›Šè‡ªåŠ¨åœæ­¢ã€‚
*   **UI ä¸äº¤äº’**ï¼š
    *   å¯æ‹–æ‹½çš„æ‚¬æµ®çª—æ§åˆ¶é¢æ¿ã€‚
    *   é€‚é…ç³»ç»ŸåŠ Bing ç½‘é¡µçš„æ·±è‰²æ¨¡å¼ (Dark Mode)ã€‚
*   **å®šæ—¶ä»»åŠ¡**ï¼š
    *   æ”¯æŒè®¾ç½®æ¯æ—¥è‡ªåŠ¨å¯åŠ¨çš„å°æ—¶å’Œåˆ†é’Ÿã€‚

---

## ğŸš€ å®‰è£…æŒ‡å—

1.  **å®‰è£…æ‰©å±•ç¨‹åº**ï¼š
    *   ç¡®ä¿æ‚¨çš„æµè§ˆå™¨ï¼ˆEdge æˆ– Chromeï¼‰å·²å®‰è£… **Tampermonkey (æ²¹çŒ´)** æ‰©å±•ã€‚
2.  **æ–°å»ºè„šæœ¬**ï¼š
    *   ç‚¹å‡»æµè§ˆå™¨å³ä¸Šè§’çš„ Tampermonkey å›¾æ ‡ï¼Œé€‰æ‹©â€œæ·»åŠ æ–°è„šæœ¬â€ã€‚
3.  **ç²˜è´´ä»£ç **ï¼š
    *   åˆ é™¤ç¼–è¾‘å™¨ä¸­é»˜è®¤ç”Ÿæˆçš„ä»£ç ã€‚
    *   å¤åˆ¶æœ¬æ–‡æ¡£ä¸‹æ–¹ **[é™„å½•ï¼šå®Œæ•´è„šæœ¬ä»£ç ]** ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚
    *   ç²˜è´´åˆ° Tampermonkey ç¼–è¾‘å™¨ä¸­ã€‚
4.  **ä¿å­˜**ï¼š
    *   æŒ‰ä¸‹ `Ctrl + S` ä¿å­˜ï¼Œæˆ–ç‚¹å‡»ç¼–è¾‘å™¨èœå•æ çš„â€œæ–‡ä»¶â€->â€œä¿å­˜â€ã€‚
5.  **ç”Ÿæ•ˆ**ï¼š
    *   æ‰“å¼€ [www.bing.com](https://www.bing.com) å³å¯çœ‹åˆ°è„šæœ¬æ‚¬æµ®çª—ã€‚

---

## ğŸ“– ä½¿ç”¨è¯´æ˜

### 1. æ‚¬æµ®çª—ç•Œé¢ä»‹ç»
è„šæœ¬åŠ è½½åï¼Œä¼šåœ¨é¡µé¢å³ä¸Šè§’æ˜¾ç¤ºä¸€ä¸ªæ‚¬æµ®çª—ï¼ˆå¯æ‹–æ‹½ä½ç½®ï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹æ§åˆ¶é¡¹ï¼š

*   **æ¦œå•**ï¼šé€‰æ‹©æœç´¢å…³é”®è¯çš„æ¥æºï¼ˆå¦‚å¾®åšçƒ­æœã€çŸ¥ä¹ç­‰ï¼‰ã€‚
*   **ä»»åŠ¡**ï¼š
    *   **å¼€å¯** (Checkbox)ï¼šå‹¾é€‰åï¼Œç‚¹å‡»â€œå¼€å§‹â€æ—¶ä¼šä¼˜å…ˆè·³è½¬åˆ° Rewards é¡µé¢å®Œæˆç‚¹å‡»ä»»åŠ¡ï¼Œç„¶åå†å›æ¥æœç´¢ã€‚
    *   **é‡è¯•**ï¼šè®¾ç½®æ¯æ—¥ä»»åŠ¡å¤±è´¥é‡è¯•çš„æ¬¡æ•°ã€‚
*   **æœ‰æ•ˆæœ**ï¼š
    *   å·¦ä¾§æ•°å­—ï¼šä»Šæ—¥å·²å®Œæˆçš„æœ‰æ•ˆæœç´¢æ¬¡æ•°ã€‚
    *   è¾“å…¥æ¡†ï¼šè®¾ç½®ä»Šæ—¥ç›®æ ‡æœç´¢æ¬¡æ•°ï¼ˆé»˜è®¤ 50 æ¬¡ï¼Œä¹Ÿå°±æ˜¯ç§»åŠ¨ç«¯+PCç«¯çš„å¤§è‡´æ€»å’Œï¼‰ã€‚
*   **è‡ªåŠ¨**ï¼šè®¾ç½®æ¯å¤©è‡ªåŠ¨å¼€å§‹è¿è¡Œçš„æ—¶é—´ï¼ˆéœ€ä¿æŒæµè§ˆå™¨å¼€å¯ï¼‰ã€‚
*   **å¤±è´¥åœ**ï¼šè¿ç»­å¤šå°‘æ¬¡æœç´¢æœªå¢åŠ ç§¯åˆ†åï¼Œè‡ªåŠ¨åœæ­¢è„šæœ¬ï¼ˆé˜²æ­¢è´¦å·è¢«é£æ§ï¼‰ã€‚
*   **å¼€å§‹/åœæ­¢æŒ‰é’®**ï¼šæ‰‹åŠ¨æ§åˆ¶è„šæœ¬è¿è¡Œã€‚

### 2. æ¨èè¿è¡Œæµç¨‹
1.  æ‰“å¼€ Bing æœç´¢é¦–é¡µã€‚
2.  åœ¨æ‚¬æµ®çª—ä¸­å‹¾é€‰ **â€œå¼€å¯â€** (ä»»åŠ¡)ï¼Œä»¥ç¡®ä¿æ¯æ—¥çš„ç‚¹å‡»å¥–åŠ±ä¹Ÿèƒ½æ‹¿åˆ°ã€‚
3.  è®¾ç½® **æœ‰æ•ˆæœ** æ¬¡æ•°ï¼ˆå»ºè®®ï¼šå¦‚æœä½ æœ‰ç§»åŠ¨ç«¯æ¨¡æ‹Ÿï¼Œå¯è®¾ä¸º PC(30) + Mobile(20) â‰ˆ 50ï¼›å¦‚æœä»…PCï¼Œè®¾ä¸º 30-35 å³å¯ï¼‰ã€‚
4.  ç‚¹å‡» **â€œå¼€å§‹â€**ã€‚
    *   è„šæœ¬ä¼šè‡ªåŠ¨è·³è½¬åˆ° Rewards é¡µé¢åšä»»åŠ¡ã€‚
    *   ä»»åŠ¡å®Œæˆåè‡ªåŠ¨è·³å›æœç´¢é¡µå¼€å§‹åˆ·å…³é”®è¯ã€‚
    *   è¾¾åˆ°æŒ‡å®šæ¬¡æ•°åè‡ªåŠ¨åœæ­¢ã€‚

### 3. å¸¸è§é—®é¢˜ (FAQ)

*   **Q: è„šæœ¬æ˜¾ç¤ºâ€œç­‰å¾…å†·å´â€æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ**
    *   A: ä¸ºäº†é˜²æ­¢è¢«å¾®è½¯åˆ¤å®šä¸ºæœºå™¨äººï¼Œè„šæœ¬åœ¨æ¯æ¬¡æœç´¢åä¼šå¼ºåˆ¶ç­‰å¾… 8~14 ç§’ã€‚è¯·è€å¿ƒç­‰å¾…ï¼Œä¸è¦æ‰‹åŠ¨é¢‘ç¹åˆ·æ–°ã€‚
*   **Q: ä¸ºä»€ä¹ˆç§¯åˆ†ä¸æ¶¨äº†ï¼Ÿ**
    *   A: å¯èƒ½æ˜¯ä»Šæ—¥ç§¯åˆ†å·²è¾¾ä¸Šé™ï¼Œæˆ–è€…æ˜¯å¾®è½¯æœåŠ¡å™¨å»¶è¿Ÿï¼Œä¹Ÿå¯èƒ½æ˜¯æ‚¨çš„è´¦å·è¿›å…¥äº†â€œå†·å´æœŸâ€ï¼ˆ15åˆ†é’Ÿå†…åªèƒ½å¾—å‡ æ¬¡åˆ†ï¼‰ã€‚è„šæœ¬æ£€æµ‹åˆ°è¿ç»­æ— åˆ†åä¼šè‡ªåŠ¨åœæ­¢ä¿æŠ¤è´¦å·ã€‚
*   **Q: å¦‚ä½•æœ€å°åŒ–æ‚¬æµ®çª—ï¼Ÿ**
    *   A: ç‚¹å‡»æ‚¬æµ®çª—æ ‡é¢˜æ å³ä¾§çš„ `âˆ’` å·å³å¯æŠ˜å ï¼Œç‚¹å‡» `+` å·å±•å¼€ã€‚

---

## ğŸ§© é™„å½•ï¼šå®Œæ•´è„šæœ¬ä»£ç 

å¤åˆ¶ä»¥ä¸‹ä»£ç åˆ° Tampermonkey ä¸­ï¼š

```javascript
// ==UserScript==
// @name         å¾®è½¯Bing å¿…åº”ç§¯åˆ†è‡ªåŠ¨è„šæœ¬ (å«æ¯æ—¥ä»»åŠ¡-ç§¯åˆ†å˜åŒ–é‡è¯•ç‰ˆ-å…¨åŠŸèƒ½ä¿®å¤)
// @version      2025.12.22.10
// @description  å¿…åº” Bing æœç´¢æ·»åŠ ä»Šæ—¥çƒ­æ¦œï¼Œæ‚¬æµ®çª—æ¨¡å¼ï¼Œæ™ºèƒ½æ£€æµ‹ç§¯åˆ†å˜åŒ–ï¼Œè‡ªåŠ¨æ¢æ¦œå•ï¼Œæ”¯æŒæ¯æ—¥ä»»åŠ¡è‡ªåŠ¨ç‚¹å‡»ï¼Œå»¶è¿Ÿåˆ·æ–°ç¡®ä¿ä»»åŠ¡å®Œæˆï¼Œé˜²æ­»å¾ªç¯ï¼Œé‡è¯•é€»è¾‘æ”¹ä¸ºåŸºäºç§¯åˆ†å˜åŒ–ã€‚ä¿®å¤è·¨å¤©ä¸æ¢æ¦œé—®é¢˜ã€‚
// @author       8969
// @match        *://*.bing.com/search*
// @match        https://rewards.bing.com/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=bing.com
// @require      https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js#sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==
// @license      GPL-3.0-or-later; https://www.gnu.org/licenses/gp
// @antifeature referral-link This script includes a refer link.
// @grant        unsafeWindow
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// ==/UserScript==

// æµ‹è¯•æ¨¡å¼å¼€å…³
// 1: å¼€å¯æµ‹è¯•æ¨¡å¼ã€‚ç‚¹å‡»â€œå¼€å§‹â€æ—¶ï¼Œå¼ºåˆ¶é‡ç½®ä»Šæ—¥æ‰€æœ‰çŠ¶æ€ï¼ˆç”¨äºè°ƒè¯•ï¼‰ã€‚
// 0: æ­£å¸¸æ¨¡å¼ã€‚æ™ºèƒ½åˆ¤æ–­æ˜¯å¦å·²å®Œæˆï¼Œå®Œæˆåä¸å†é‡å¤è¿è¡Œã€‚
const TEST_MODE = 0;
const SCRIPT_LOAD_DATE = getLocalDateStr(); // è®°å½•è„šæœ¬åŠ è½½æ—¶çš„æ—¥æœŸ.

// ==========================================
// æ ·å¼å®šä¹‰åŒº (UI)
// ==========================================
GM_addStyle(`
    #rebang-widget {
        position: fixed;
        width: 320px;
        background-color: rgba(255, 255, 255, 0.98);
        box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        border-radius: 12px;
        z-index: 99999;
        font-family: 'Segoe UI', Arial, sans-serif;
        border: 1px solid #e0e0e0;
        transition: height 0.3s;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        color-scheme: light; /* é»˜è®¤äº®è‰² */
    }

    /* === æ»šåŠ¨æ¡ç¾åŒ– === */
    #rebang-body::-webkit-scrollbar { width: 6px; }
    #rebang-body::-webkit-scrollbar-track { background: transparent; }
    #rebang-body::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }
    #rebang-body::-webkit-scrollbar-thumb:hover { background-color: #aaa; }

    /* === è‡ªåŠ¨è®¾ç½®è¡Œæ ·å¼ (ç§»é™¤è¡Œå†…æ ·å¼ï¼Œæ”¹ä¸ºClassæ§åˆ¶) === */
    .auto-row {
        background: #f0f0f0;
        padding: 5px;
        border-radius: 4px;
        border: 1px solid transparent; /* å ä½é˜²æ­¢æŠ–åŠ¨ */
    }

    /* === é€‚é…ç³»ç»Ÿçº§æ·±è‰²æ¨¡å¼ === */
    @media (prefers-color-scheme: dark) {
        #rebang-widget { background-color: #2b2b2b; border-color: #444; color: #eee; color-scheme: dark; }
        #rebang-header { background-color: #3a3a3a !important; border-bottom-color: #444 !important; }
        .keyword-link { color: #bbb !important; }
        .keyword-link:hover { color: #fff !important; }
        #rebang-widget select, #rebang-widget input { background-color: #444; color: #fff; border: 1px solid #555; }
        #rebang-widget select option { background-color: #444; color: #fff; }
        #rebang-body::-webkit-scrollbar-thumb { background-color: #555; }
        #rebang-body::-webkit-scrollbar-thumb:hover { background-color: #777; }

        /* è‡ªåŠ¨éƒ¨åˆ†æ·±è‰²é€‚é… */
        .auto-row { background-color: #3a3a3a; border-color: #444; }
    }

    /* === é€‚é… Bing ç½‘é¡µç‰ˆå¼ºåˆ¶æ·±è‰²æ¨¡å¼ (ç±»å .b_dark) === */
    .b_dark #rebang-widget {
        background-color: #2b2b2b;
        border-color: #444;
        color: #eee;
        color-scheme: dark;
    }
    .b_dark #rebang-header {
        background-color: #3a3a3a !important;
        border-bottom-color: #444 !important;
    }
    .b_dark #rebang-widget .keyword-link { color: #bbb !important; }
    .b_dark #rebang-widget .keyword-link:hover { color: #fff !important; }
    .b_dark #rebang-widget select,
    .b_dark #rebang-widget input {
        background-color: #444;
        color: #fff;
        border: 1px solid #555;
    }
    .b_dark #rebang-widget select option { background-color: #444; color: #fff; }
    .b_dark #rebang-body::-webkit-scrollbar-thumb { background-color: #555; }
    .b_dark #rebang-body::-webkit-scrollbar-thumb:hover { background-color: #777; }

    /* è‡ªåŠ¨éƒ¨åˆ†æ·±è‰²é€‚é… (Bingç±»å) */
    .b_dark .auto-row {
        background-color: #3a3a3a;
        border-color: #444;
    }

    /* === é€šç”¨ç»„ä»¶æ ·å¼ === */
    #rebang-header {
        padding: 10px 15px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #eee;
        cursor: move;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
    }
    #rebang-title { font-weight: bold; font-size: 14px; color: #0078d4; }
    #rebang-controls { display: flex; gap: 8px; }
    .rebang-btn-icon { cursor: pointer; font-size: 16px; line-height: 1; opacity: 0.6; }
    .rebang-btn-icon:hover { opacity: 1; }
    #rebang-body { padding: 12px; max-height: 520px; overflow-y: auto; display: block; scrollbar-width: thin; }
    #rebang-body.minimized { display: none; }
    .control-row { display: flex; align-items: center; margin-bottom: 8px; flex-wrap: wrap; gap: 5px; font-size: 12px; }
    .form-select { padding: 2px 5px; border-radius: 4px; border: 1px solid #ccc; max-width: 100px; font-size: 12px; outline: none; }
    .time-select { width: 45px; text-align: center; }
    button.rebang-btn { background: #0078d4; color: white; border: none; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    button.rebang-btn:hover { background: #006abc; }
    button.rebang-btn.stop { background: #d9534f; }
    button.rebang-btn.save { background: #107c10; margin-left: auto; }
    #ext-keywords-list { margin-top: 10px; display: flex; flex-wrap: wrap; }
    .keyword-link { display: block; width: 100%; padding: 3px 0; text-decoration: none; color: #333; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .keyword-link:hover { color: #0078d4; background: rgba(0,0,0,0.03); }
    .keyword-link-current { font-weight: bold; color: #d9534f !important; }
    #ex-user-msg { font-size: 12px; color: #d9534f; margin-top: 5px; display: block; min-height: 18px; }
    .checkbox-wrapper { display: flex; align-items: center; gap: 4px; }
    input[type=checkbox] { accent-color: #0078d4; }
`);

this.$ = this.jQuery = jQuery.noConflict(true);

// ==========================================
// å·¥å…·å‡½æ•°ä¸çŠ¶æ€ç®¡ç†
// ==========================================

// GM_getValue / GM_setValue å°è£…
function getVal(key, defaultValue) { return GM_getValue(key, defaultValue); }
function setVal(key, value) { GM_setValue(key, value); }

// å¸¸é‡å®šä¹‰
const prefix = "Rebang_";
const autoSearchLockKey = `${prefix}AutoSearchLock`; // æœç´¢å¼€å…³é”
const enableDailyTasksKey = `${prefix}EnableDailyTasks`; // æ˜¯å¦å¯ç”¨æ¯æ—¥ä»»åŠ¡
const maxNoGainLimitKey = `${prefix}MaxNoGainLimit`; // è¿ç»­æ— ç§¯åˆ†ç†”æ–­é˜ˆå€¼
const dailyTaskMaxRetriesKey = `${prefix}DailyTaskMaxRetries`; // ä»»åŠ¡é‡è¯•æ¬¡æ•°
const autoSearchLockExpiresKey = `${prefix}AutoSearchLockExpires`; // æœç´¢å†·å´æ—¶é—´
const consecutiveNoGainKey = `${prefix}ConsecutiveNoGainCount`; // è¿ç»­æ— ç§¯åˆ†è®¡æ•°
const lastPointsKey = `${prefix}LastPoints`; // ä¸Šæ¬¡è®°å½•çš„ç§¯åˆ†
const autoStartHourKey = `${prefix}AutoStartHour`; // è‡ªåŠ¨å¼€å§‹å°æ—¶
const autoStartMinKey = `${prefix}AutoStartMin`; // è‡ªåŠ¨å¼€å§‹åˆ†é’Ÿ
const limitSearchCountKey = `${prefix}LimitSearchCount`; // æ¯æ—¥æœç´¢é™åˆ¶

// ==========================================
// æ–°å¢ï¼šå¤šæ ‡ç­¾é¡µäº’æ–¥ä¸ååŒé€»è¾‘å¸¸é‡
// ==========================================
const globalLockKey = `${prefix}GlobalLastRunTime`;   // å…¨å±€æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´ï¼ˆæ‰€æœ‰æ ‡ç­¾é¡µå…±äº«ï¼‰
const globalMasterTabKey = `${prefix}GlobalMasterTabId`; // å½“å‰ä¸»æ§æ ‡ç­¾é¡µçš„ID
const currentTabId = Date.now() + "_" + Math.floor(Math.random() * 10000); // å½“å‰é¡µé¢çš„å”¯ä¸€ID

// ==========================================
// æ–°å¢ï¼šæ ‡ç­¾é¡µçŠ¶æ€åŒæ­¥å‡½æ•°
// ==========================================
// ç”¨äºåˆ¤æ–­å½“å‰æ ‡ç­¾é¡µæ˜¯å¦åº”è¯¥æ˜¾ç¤ºUIæˆ–æ‰§è¡Œä»»åŠ¡
function syncTabStatus() {
    // è·å–å…¨å±€æœ€åæ‰§è¡Œæ—¶é—´
    let lastRun = Number(getVal(globalLockKey, 0));
    let masterId = getVal(globalMasterTabKey, "");
    let now = Date.now();

    // åˆ¤å®šä¸»æ§æƒé€»è¾‘ï¼š
    let isMaster = false;
    if (masterId === currentTabId) {
        isMaster = true;
    } else if (now - lastRun > 15000) {
        // æŠ¢å ä¸»æ§æƒ (å¦‚æœä¸Šæ¬¡æ‰§è¡Œè¶…è¿‡15ç§’ï¼Œè§†ä¸ºå¯¹æ–¹å¡æ­»)
        setVal(globalMasterTabKey, currentTabId);
        setVal(globalLockKey, now);
        isMaster = true;
        console.log(`[Rebang] tab ${currentTabId} took over master control.`);
    }

    // === ã€æ ¸å¿ƒä¿®æ”¹ç‚¹ã€‘ ===
    // ç§»é™¤ä¹‹å‰çš„ .hide() é€»è¾‘ï¼Œæ”¹ä¸ºæ‰€æœ‰é¡µé¢å¸¸é©»æ˜¾ç¤º
    if ($("#rebang-widget").length > 0) {
        $("#rebang-widget").show(); // å¼ºåˆ¶æ˜¾ç¤º

        if (isMaster) {
            // å¦‚æœæ˜¯ä¸»æ§é¡µï¼Œæ­£å¸¸æ˜¾ç¤º
            $("#rebang-title").text("ğŸ”¥ å¿…åº”ç§¯åˆ†åŠ©æ‰‹ (ä¸»æ§)");
            $("#rebang-widget").css("opacity", "1"); // å®Œå…¨ä¸é€æ˜
        } else {
            // å¦‚æœæ˜¯å‰¯é¡µé¢ï¼Œä¹Ÿæ˜¾ç¤ºï¼Œä½†æ ‡é¢˜æç¤ºâ€œå¾…æœºâ€
            // è¿™æ ·ä½ å°±å¯ä»¥åœ¨ä»»ä½•é¡µé¢ä¿®æ”¹è®¾ç½®äº†
            $("#rebang-title").text("ğŸ’¤ å¿…åº”ç§¯åˆ†åŠ©æ‰‹ (å¾…æœº)");
            $("#rebang-widget").css("opacity", "0.85"); // ç¨å¾®é€æ˜ä¸€ç‚¹ç‚¹ä»¥ç¤ºåŒºåˆ†
        }

        // ç§»é™¤å¼ºåˆ¶åŒæ­¥æœ€å°åŒ–çš„é€»è¾‘ï¼Œé˜²æ­¢ä½ åœ¨Aé¡µé¢å±•å¼€ï¼ŒBé¡µé¢çªç„¶æŠŠä½ å…³ä¸Šçš„æƒ…å†µ
        // ä¿ç•™æ‰‹åŠ¨ç‚¹å‡»æŠ˜å å³å¯
    }

    return isMaster;
}

// ==========================================
// æ–°å¢ï¼šæ–°å»ºæ ‡ç­¾é¡µæ‰§è¡Œå…œåº•é€»è¾‘
// ==========================================
function openNewWorkerTab() {
    // åªæœ‰åœ¨å¼€å¯è‡ªåŠ¨æœç´¢ä¸”è¿˜æ²¡æœå®Œæ—¶æ‰è§¦å‘
    if (getVal(autoSearchLockKey, "off") === "on") {
        showUserMessage("é¡µé¢å¡æ»ï¼Œå¼€å¯æ–°çª—å£æ¥åŠ›...");

        // 1. æ‰“å¼€æ–°æ ‡ç­¾é¡µ
        window.open("https://www.bing.com/search?q=Bing+Rewards+Relay&form=QBRE", "_blank");

        // 2. ã€å…³é”®ä¿®æ”¹ã€‘ä¸è¦è°ƒç”¨ stopAutoSearch()ï¼
        // å› ä¸º stopAutoSearch ä¼šæŠŠå…¨å±€å¼€å…³è®¾ä¸º offï¼Œå¯¼è‡´æ–°é¡µé¢ä¸è¿è¡Œã€‚

        // 3. å¯ä»¥åœ¨æœ¬åœ°åšä¸€ä¸ªè§†è§‰ä¸Šçš„åœæ­¢ï¼Œæˆ–è€…ç›´æ¥å…³é—­å½“å‰é¡µï¼ˆå¦‚æœæµè§ˆå™¨å…è®¸ï¼‰
        $("#ext-autosearch-lock").text("å·²ç§»äº¤").addClass("stop");

        // 4. å¯é€‰ï¼šå°è¯•å…³é—­å½“å‰æ­»å¾ªç¯çš„é¡µé¢ (å¤§éƒ¨åˆ†æµè§ˆå™¨ä¼šæ‹¦æˆªè„šæœ¬å…³é—­éè„šæœ¬æ‰“å¼€çš„é¡µé¢ï¼Œä½†å¯ä»¥å°è¯•)
        // window.close();

        // 5. æˆ–è€…ç®€å•åœ°è·³è½¬ç©ºç™½é¡µï¼Œå½»åº•ç»“æŸå½“å‰é¡µé¢çš„é€»è¾‘å¹²æ‰°
        // window.location.href = "about:blank";
    }
}

// çŠ¶æ€ Key (ç”¨äºè·¨æ ‡ç­¾é¡µé€šä¿¡)
const rewardsFailCountKey = `${prefix}RewardsFailCount`; // ç§¯åˆ†é¡µï¼šè¿ç»­æœªæ¶¨åˆ†è®¡æ•°
const rewardsLastPointsKey = `${prefix}RewardsLastPoints`; // ç§¯åˆ†é¡µï¼šä¸Šæ¬¡ç‚¹å‡»æ—¶çš„ç§¯åˆ†
const jumpFailCountKey = `${prefix}JumpFailCount`; // æœç´¢é¡µï¼šè¿ç»­è·³è½¬æ— æ”¶ç›Šè®¡æ•°
const jumpLastPointsKey = `${prefix}JumpLastPoints`; // æœç´¢é¡µï¼šä¸Šæ¬¡è·³è½¬æ—¶çš„ç§¯åˆ†
const rewardsClickTimeKey = `${prefix}RewardsClickTime`; // ä»»åŠ¡ç‚¹å‡»æ—¶é—´æˆ³

const selectedChannelKey = `${prefix}SelectedChannel`; // å½“å‰é€‰ä¸­çš„æ¦œå•
const currentKeywordIndexKey = `${prefix}CurrentKeywordIndex`; // å½“å‰æœç´¢åˆ°ç¬¬å‡ ä¸ªè¯
const channelListKey = `${prefix}Channels`; // æ¦œå•åˆ—è¡¨ç¼“å­˜
const widgetPosKey = `${prefix}WidgetPosition`; // æ‚¬æµ®çª—ä½ç½®
const widgetStateKey = `${prefix}WidgetState`; // æ‚¬æµ®çª—æŠ˜å çŠ¶æ€

// åŠ¨æ€ Key ç”Ÿæˆå‡½æ•°
const getDailyTaskRedirectTimeKey = () => `${prefix}DailyTaskRedirectTime`;

// ã€é‡è¦ã€‘è·å–æœ¬åœ°æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
// è§£å†³äº†åŸç‰ˆä½¿ç”¨ UTC æ—¶é—´å¯¼è‡´æ—©ä¸Š 0-8 ç‚¹åˆ¤å®šä¸ºæ˜¨å¤©çš„ bug
function getLocalDateStr() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// æ¯æ—¥åŠ¨æ€ Key
function getAutoSearchCountKey() {
  return `${prefix}AutoSearchCount_${getLocalDateStr()}`;
}

function getAutoStartTriggeredKey() {
  return `${prefix}AutoStartTriggered_${getLocalDateStr()}`;
}

function getDailyTasksDoneKey() {
  return `${prefix}DailyTasksDone_${getLocalDateStr()}`;
}

// ==========================================
// æ ¸å¿ƒé€»è¾‘ï¼šè·å–ç§¯åˆ† (æ·±åº¦ä¿®å¤ç‰ˆ)
// ==========================================

// è¾…åŠ©è§£æå‡½æ•°ï¼šå®‰å…¨è§£æç§¯åˆ†æ–‡æœ¬
function parsePointsText(text) {
    if (!text) return null;
    // 1. å»é™¤é€—å· (ä¾‹å¦‚ "17,036" -> "17036")
    let clean = text.replace(/,/g, '');
    // 2. æå–ç¬¬ä¸€ç»„è¿ç»­æ•°å­—ï¼Œå¿½ç•¥åç»­å¹²æ‰°å­—ç¬¦
    // è¿™ä¸€æ­¥èƒ½é˜²æ­¢å¦‚æœæœ‰æ¼ç½‘ä¹‹é±¼æ‹¼æ¥åˆ°ä¸€èµ·ï¼Œåªå–å‰é¢çš„éƒ¨åˆ†
    let match = clean.match(/(\d+)/);
    if (match) {
        return parseInt(match[1], 10);
    }
    return null;
}

// ã€æœç´¢é¡µé¢ã€‘ä¸“ç”¨é€»è¾‘ (å®Œå…¨å¤åˆ»è„šæœ¬2)
function getSearchPagePoints() {
    // ä¼˜å…ˆçº§ 1: è„šæœ¬2 éªŒè¯æœ€æœ‰æ•ˆçš„é€‰æ‹©å™¨ (.points-container)
    let $pointsEl = $(".points-container");
    if ($pointsEl.length > 0) {
        // å¿…é¡»ä½¿ç”¨ first() é˜²æ­¢å¤šå…ƒç´ æ‹¼æ¥
        return parsePointsText($pointsEl.first().text());
    }

    // ä¼˜å…ˆçº§ 2: ç§»åŠ¨ç«¯/ä¾§è¾¹æ  (å¤‡ç”¨)
    let $sidebarPoints = $(".b_id_c .id_text");
    if ($sidebarPoints.length > 0) {
        return parsePointsText($sidebarPoints.first().text());
    }

    // ä¼˜å…ˆçº§ 3: æ—§ç‰ˆ ID (ä»…å½“ç¡®è®¤ä¸ºæ•°å­—æ—¶è¿”å›)
    let $oldId = $("#id_rc");
    if ($oldId.length > 0) {
        let txt = $oldId.text().trim();
        if (txt && /\d/.test(txt)) return parsePointsText(txt);
    }

    return null;
}

// ã€Rewardsé¡µé¢ã€‘ä¸“ç”¨é€»è¾‘ (é’ˆå¯¹ä½ æä¾›çš„ HTML ç»“æ„ä¿®å¤)
function getRewardsPagePoints() {
    // ä¼˜å…ˆçº§ 1: ã€ç²¾ç¡®åŒ¹é…ã€‘ç”¨æˆ·æä¾›çš„ HTML ç»“æ„ (#balanceToolTipDiv)
    // ç»“æ„: #balanceToolTipDiv -> .pointsValue -> span
    let $userTarget = $("#balanceToolTipDiv .pointsValue span");
    if ($userTarget.length > 0) {
        // å…³é”®ä¿®å¤ï¼šä½¿ç”¨ .first() ç¡®ä¿åªè·å–ç¬¬ä¸€ä¸ªåŒ¹é…é¡¹ï¼Œé˜²æ­¢æ•°å€¼è¶…å‡º
        return parsePointsText($userTarget.first().text());
    }

    // ä¼˜å…ˆçº§ 2: æ–°ç‰ˆ Dashboard Header
    let $header = $("dashboard-header").find("span.title-m, span.headline-m, .mee-icon-text span");
    if ($header.length > 0) {
        return parsePointsText($header.first().text());
    }

    // ä¼˜å…ˆçº§ 3: åŠ¨ç”»è®¡æ•°å™¨ (å¿…é¡»åŠ  .first() !!!)
    // ä¹‹å‰çš„ bug å°±æ˜¯å› ä¸ºè¿™é‡Œè·å–äº†é¡µé¢æ‰€æœ‰è®¡æ•°å™¨å¹¶æ‹¼æ¥äº†
    let $anim = $("mee-rewards-counter-animation span");
    if ($anim.length > 0) {
        return parsePointsText($anim.first().text());
    }

    // ä¼˜å…ˆçº§ 4: ä½™é¢å¡ç‰‡å…œåº•
    let $balance = $("div[data-testid='balance-card'] h1, div[class*='balance'] span");
    if ($balance.length > 0) {
        return parsePointsText($balance.first().text());
    }

    return null;
}

// ä¸»å…¥å£ï¼šä¸¥æ ¼åˆ†æµï¼Œäº’ä¸å¹²æ‰°
function getBingPoints() {
    if (window.location.hostname === "rewards.bing.com") {
        return getRewardsPagePoints();
    } else {
        return getSearchPagePoints();
    }
}

function stopAutoSearch(msg) {
    setVal(autoSearchLockKey, "off");
    $("#ext-autosearch-lock").text("å¼€å§‹").removeClass("stop");
    if(msg) showUserMessage(msg);
}

// ã€å…³é”®é€»è¾‘ã€‘æ¯å¤©éšæœºåˆ‡æ¢æ¦œå•å¹¶æ¸…ç†æ—§ç¼“å­˜
// ç¡®ä¿æ¯å¤©ç¬¬ä¸€æ¬¡è¿è¡Œæ—¶ï¼Œæˆ–è€…æŒ‚æœºè·¨å¤©æ—¶ï¼Œè‡ªåŠ¨æ¢ä¸€ä¸ªæ–°æ¦œå•å¹¶è·å–æœ€æ–°æ•°æ®
function checkAndRandomizeDailyChannel(channelList) {
    if (!channelList || channelList.length === 0) return;

    const todayStr = getLocalDateStr(); // è·å–æœ¬åœ°æ—¥æœŸ
    const lastSelectDate = localStorage.getItem(`${prefix}LastAutoSelectDate`);

    // å¦‚æœä¸Šæ¬¡é€‰æ‹©æ—¥æœŸä¸æ˜¯ä»Šå¤©
    if (lastSelectDate !== todayStr) {
        console.log(`[Rebang] æ£€æµ‹åˆ°æ–°çš„ä¸€å¤© (${todayStr})ï¼Œæ­£åœ¨éšæœºé€‰æ‹©æ¦œå•...`);

        // éšæœºé€‰ä¸€ä¸ªæ¦œå•
        const randomIndex = Math.floor(Math.random() * channelList.length);
        const newChannel = channelList[randomIndex];

        // æ›´æ–°çŠ¶æ€
        localStorage.setItem(selectedChannelKey, newChannel);
        localStorage.setItem(currentKeywordIndexKey, 0);
        localStorage.setItem(`${prefix}LastAutoSelectDate`, todayStr);

        // å¼ºåˆ¶æ¸…é™¤ SessionStorage ä¸­çš„æ—§ç¼“å­˜ï¼Œè¿«ä½¿ initKeywords é‡æ–°è¯·æ±‚æœ€æ–°æ•°æ®
        sessionStorage.removeItem(`${prefix}${newChannel}`);

        // æ›´æ–° UI
        $("#ext-channels").val(newChannel);
        showUserMessage(`æ–°çš„ä¸€å¤©ï¼Œå·²éšæœºåˆ‡æ¢è‡³: ${newChannel}`);

        // é‡æ–°åˆå§‹åŒ–
        initKeywords();
    }
}

// åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ¦œå• (å½“å‰æ¦œå•æœå®Œæ—¶)
function switchToNextChannel() {
    let channelList = JSON.parse(sessionStorage.getItem(channelListKey));
    let currentChannel = getCurrentChannel();

    if (channelList && channelList.length > 0) {
        let currentIndex = channelList.indexOf(currentChannel);
        if (currentIndex !== -1 && currentIndex < channelList.length - 1) {
            let nextChannel = channelList[currentIndex + 1];
            showUserMessage(`æœ¬æ¦œå•å·²æœå®Œï¼Œåˆ‡æ¢è‡³: ${nextChannel}...`);
            localStorage.setItem(selectedChannelKey, nextChannel);
            localStorage.setItem(currentKeywordIndexKey, 0);
            sessionStorage.removeItem(`${prefix}${nextChannel}`); // æ¸…é™¤ç¼“å­˜ä»¥é˜²ä¸‡ä¸€
            setTimeout(() => { location.reload(); }, 1000);
            return;
        }
    }
    stopAutoSearch("æ‰€æœ‰æ¦œå•å·²å®Œæˆæˆ–æ— æ³•åˆ‡æ¢ã€‚");
}

function truncateText(str, maxlength) {
  return str.length > maxlength ? str.slice(0, maxlength - 1) + "â€¦" : str;
}

function getCurrentChannelKeywordsCacheKey() {
  return `${prefix}${getCurrentChannel()}`;
}

function getCurrentChannel() {
  return localStorage.getItem(selectedChannelKey) ?? "å¾®åš";
}

function showUserMessage(msg) {
  $("#ex-user-msg").text(msg);
}

function doSearch(keyword) {
    // 1. å°è¯•ä½¿ç”¨è„šæœ¬ 2 çš„é€»è¾‘ï¼šæ¨¡æ‹Ÿç‚¹å‡»æœç´¢æŒ‰é’®
    // è¿™æ · Bing ä¼šè‡ªåŠ¨æ·»åŠ  &form=QBRE, &cvid=... ç­‰å…³é”®å‚æ•°
    let $input = $("#sb_form_q");
    let $btn = $("#sb_form_go"); // æ¡Œé¢ç«¯å¸¸ç”¨ ID

    // å…¼å®¹æ€§æŸ¥æ‰¾æŒ‰é’®
    if ($btn.length === 0) $btn = $("#sb_form_submit"); // ç§»åŠ¨ç«¯æˆ–æ—§ç‰ˆ
    if ($btn.length === 0) $btn = $(".search_icon, .b_searchboxSubmit"); // é€šç”¨ç±»å

    if ($input.length > 0 && $btn.length > 0) {
        // å¡«å…¥å…³é”®è¯
        $input.val(keyword);

        // è§¦å‘ React/Angular ç­‰æ¡†æ¶å¯èƒ½éœ€è¦çš„ input äº‹ä»¶
        try {
            let evt = new Event('input', { bubbles: true });
            $input[0].dispatchEvent(evt);
            $input[0].value = keyword; //å†ä¸€æ¬¡ç¡®ä¿èµ‹å€¼
        } catch(e) {}

        // æ¨¡æ‹Ÿç‚¹å‡»
        $btn[0].click();
    }
    else {
        // 2. å…œåº•æ–¹æ¡ˆï¼šå¦‚æœæ‰¾ä¸åˆ°æŒ‰é’®ï¼Œæ‰‹åŠ¨æ„å»ºå¸¦å‚æ•°çš„ URL
        // &form=QBRE æ˜¯ Bing åˆ¤æ–­æ˜¯å¦ä¸ºâ€œæ‰‹åŠ¨æœç´¢â€çš„æ ¸å¿ƒå‚æ•°
        window.location.href = "https://www.bing.com/search?q=" + encodeURIComponent(keyword) + "&form=QBRE&sp=-1&lq=0";
    }
}

// ==========================================
// æ¯æ—¥ä»»åŠ¡é»‘åå•ç®¡ç† (è·³è¿‡å¡ä½çš„ä»»åŠ¡)
// ==========================================
function getTaskBlacklistKey() {
    return `${prefix}TaskBlacklist_${getLocalDateStr()}`;
}

function getTaskBlacklist() {
    return JSON.parse(getVal(getTaskBlacklistKey(), "[]"));
}

function addTaskToBlacklist(url) {
    let list = getTaskBlacklist();
    if (url && !list.includes(url)) {
        list.push(url);
        setVal(getTaskBlacklistKey(), JSON.stringify(list));
    }
}

// ==========================================
// é¡µé¢é€»è¾‘ï¼šRewards ä»»åŠ¡é¡µ
// ==========================================
function handleRewardsPage() {
    let isLocked = getVal(autoSearchLockKey, "off");
    let currentPoints = getBingPoints();

    if (currentPoints !== null) {
        $("#ext-rewards-points").text(currentPoints);
        setVal(lastPointsKey, currentPoints);
    }

    // å¦‚æœè„šæœ¬æœªå¼€å¯ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
    if (isLocked !== "on") {
         showUserMessage("è„šæœ¬æœªå¼€å¯");
         return;
    }

    if (getVal(enableDailyTasksKey, false) !== true) {
        showUserMessage("æœªå¯ç”¨æ¯æ—¥ä»»åŠ¡ï¼Œè¿”å›...");
        setTimeout(() => { window.location.href = "https://www.bing.com/search?q=Bing+Rewards"; }, 2000);
        return;
    }

    let $cardGroup = $("#more-activities");
    if ($cardGroup.length === 0) {
        showUserMessage("ç­‰å¾…ä»»åŠ¡åˆ—è¡¨åŠ è½½...");
        return;
    }

    // æ£€æµ‹æ˜¯å¦å¤„äºç‚¹å‡»åçš„å†·å´æœŸ
    let lastClickTime = Number(getVal(rewardsClickTimeKey, 0));
    let now = new Date().getTime();
    let waitDuration = 10000; // æ¯æ¬¡ç‚¹å‡»åç­‰å¾… 10 ç§’éªŒè¯

    if (now - lastClickTime < waitDuration) {
        let left = Math.ceil((waitDuration - (now - lastClickTime)) / 1000);
        showUserMessage(`ç­‰å¾…éªŒè¯... ${left}s`);

        if (left <= 1) {
             setVal(rewardsClickTimeKey, 0);
             showUserMessage("åˆ·æ–°çŠ¶æ€...");
             location.reload();
        }
        return;
    }

    // çŠ¶æ€å‡†å¤‡
    let rewardsLastPoints = Number(getVal(rewardsLastPointsKey, -1));
    let failCount = Number(getVal(rewardsFailCountKey, 0));
    let maxRetries = Number(getVal(dailyTaskMaxRetriesKey, 3));
    let blacklist = getTaskBlacklist();

    // å¯»æ‰¾æœªå®Œæˆçš„ä»»åŠ¡
    let $cards = $("#more-activities mee-card");
    let hasPending = false;
    let targetLink = null;
    let targetName = "";
    let targetUrl = "";

    $cards.each(function() {
        if (targetLink) return;

        let $icon = $(this).find(".mee-icon-SkypeCircleCheck");

        if ($icon.length === 0) { // æ²¡æœ‰ç»¿è‰²å‹¾å‹¾
            let $link = $(this).find("a");
            if ($link.length > 0) {
                let url = $link.attr("href");

                // è·³è¿‡é»‘åå•
                if (blacklist.includes(url)) {
                    return;
                }

                hasPending = true;
                targetLink = $link;
                targetName = $link.text().trim() || "ä»»åŠ¡";
                targetUrl = url;
            }
        }
    });

    // ç§¯åˆ†éªŒè¯é€»è¾‘ï¼šå¦‚æœç§¯åˆ†æ¶¨äº†ï¼Œé‡ç½®å¤±è´¥è®¡æ•°
    if (rewardsLastPoints !== -1 && currentPoints !== null) {
        if (currentPoints > rewardsLastPoints) {
            if (failCount > 0) console.log(`[Rebang] Points increased! Reset fail count.`);
            failCount = 0;
            setVal(rewardsFailCountKey, 0);
        }
    }

    // ç†”æ–­é€»è¾‘ï¼šå•ä»»åŠ¡å¤±è´¥æ¬¡æ•°è¿‡å¤š
    if (hasPending && targetLink && failCount > maxRetries) {
        console.log(`[Rebang] Task limit (${failCount}) reached for: ${targetName}`);
        showUserMessage(`ä»»åŠ¡[${truncateText(targetName,6)}]å¤šæ¬¡æ— åˆ†ï¼Œæ‹‰é»‘è·³è¿‡...`);

        addTaskToBlacklist(targetUrl); // åŠ å…¥é»‘åå•
        setVal(rewardsFailCountKey, 0); // é‡ç½®è®¡æ•°
        setTimeout(() => { location.reload(); }, 1500); // åˆ·æ–°é¡µé¢
        return;
    }

    // æ‰€æœ‰ä»»åŠ¡å®Œæˆæˆ–è¢«è·³è¿‡
    if (!hasPending && $cards.length > 0) {
        console.log("[Rebang] Daily tasks done (or all skipped).");
        setVal(getDailyTasksDoneKey(), true);
        showUserMessage("ä»»åŠ¡å®Œæˆ(æˆ–å·²è·³è¿‡å¡ä½ä»»åŠ¡)ï¼è¿”å›...");
        setTimeout(() => {
            window.location.href = "https://www.bing.com/search?q=Bing+Rewards+Done";
        }, 1500);
        return;
    }

    // æ‰§è¡Œç‚¹å‡»
    if (hasPending && targetLink) {
        // é¢„åˆ¤å¤±è´¥ï¼šå¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡ç‚¹å‡»ä¸”ç§¯åˆ†æ²¡æ¶¨ï¼Œå…ˆè®°ä¸€æ¬¡å¤±è´¥
        if (rewardsLastPoints !== -1 && currentPoints !== null && currentPoints <= rewardsLastPoints) {
             failCount++;
             setVal(rewardsFailCountKey, failCount);

             if (failCount > maxRetries) {
                 showUserMessage(`é‡è¯•è¶…é™ï¼Œå‡†å¤‡è·³è¿‡...`);
                 location.reload();
                 return;
             }
        } else if (currentPoints > rewardsLastPoints) {
            failCount = 0;
            setVal(rewardsFailCountKey, 0);
        }

        showUserMessage(`æ‰§è¡Œ: ${truncateText(targetName, 8)} (å¤±è¯¯:${failCount})`);

        if (currentPoints !== null) setVal(rewardsLastPointsKey, currentPoints);

        setVal(rewardsClickTimeKey, now);
        targetLink[0].click();
    }
}

// ==========================================
// Bing æœç´¢é¡µ
// ==========================================
function doAutoSearch() {
  // --- å¤šæ ‡ç­¾é¡µäº’æ–¥æ£€æŸ¥ (è¦æ±‚1 & 4) ---
  // æ¯æ¬¡æ‰§è¡Œæœç´¢å‰ï¼Œå…ˆåŒæ­¥çŠ¶æ€ã€‚å¦‚æœä¸æ˜¯ä¸»æ§é¡µï¼Œä¸”æœ‰å…¶ä»–é¡µé¢åˆšè·‘è¿‡ï¼Œåˆ™è·³è¿‡æœ¬æ¬¡æ‰§è¡Œã€‚
  let isMaster = syncTabStatus();
  let lastGlobalRun = Number(getVal(globalLockKey, 0));
  let nowTime = Date.now();
  const relayRetryKey = `${prefix}RelayRetryCount`; // æ¢é¡µé‡è¯•è®¡æ•°


  // å¦‚æœæˆ‘ä¸æ˜¯ä¸»æ§ï¼Œä¸”ä¸Šæ¬¡å…¨å±€æ‰§è¡Œåœ¨ 8ç§’å†… (æ­£å¸¸æœç´¢é—´éš”æ˜¯8-14ç§’)ï¼Œåˆ™æˆ‘ä¿æŒé™é»˜
  if (!isMaster && (nowTime - lastGlobalRun < 8000)) {
      console.log(`[Rebang] Slave tab standby. Master running.`);
      return;
  }
  // -----------------------------------

  let enableDaily = getVal(enableDailyTasksKey, false);
  let dailyDone = getVal(getDailyTasksDoneKey(), false);

  // 1. æ¯æ—¥ä»»åŠ¡è·³è½¬é€»è¾‘ (ä¼˜å…ˆæ‰§è¡Œ)
  if (enableDaily && !dailyDone) {
      let lastRedirect = Number(getVal(getDailyTaskRedirectTimeKey(), 0));
      // ä»»åŠ¡é¡µè·³è½¬å†·å´ (60ç§’)
      if (nowTime - lastRedirect < 60 * 1000) {
          let waitSec = Math.ceil((60000 - (nowTime - lastRedirect)) / 1000);
          showUserMessage(`ç­‰å¾…ä»»åŠ¡é¡µå†·å´... ${waitSec}s`);
          return;
      }

      // æŠ¢å é”ï¼Œé˜²æ­¢å…¶ä»–é¡µé¢åŒæ—¶ä¹Ÿè·³
      setVal(globalLockKey, nowTime);
      setVal(globalMasterTabKey, currentTabId);

      let currentPoints = getBingPoints();
      let jumpLastPoints = Number(getVal(jumpLastPointsKey, -1));
      let jumpFailCount = Number(getVal(jumpFailCountKey, 0));

      let uiMaxRetries = $("#ext-daily-retries").length ? Number($("#ext-daily-retries").val()) : -1;
      let maxRetries = uiMaxRetries >= 0 ? uiMaxRetries : Number(getVal(dailyTaskMaxRetriesKey, 3));

      // éªŒè¯ä¸Šæ¬¡è·³è½¬æ˜¯å¦æœ‰æ”¶ç›Š
      if (jumpLastPoints !== -1 && currentPoints !== null) {
          if (currentPoints > jumpLastPoints) {
              jumpFailCount = 0;
              setVal(jumpFailCountKey, 0);
          } else {
              jumpFailCount++;
              setVal(jumpFailCountKey, jumpFailCount);
          }
      }

      // è·³è½¬å¤±è´¥è¿‡å¤šï¼Œæ”¾å¼ƒä»»åŠ¡
      if (jumpFailCount > maxRetries) {
          showUserMessage(`æ— åˆ†è·³è½¬(${jumpFailCount}æ¬¡)è¶…é™ï¼Œè·³è¿‡`);
          setVal(getDailyTasksDoneKey(), true);
          return;
      }

      showUserMessage(`å‰å¾€ä»»åŠ¡é¡µ (æ— åˆ†æ¬¡æ•°:${jumpFailCount})...`);

      if (currentPoints !== null) setVal(jumpLastPointsKey, currentPoints);
      setVal(getDailyTaskRedirectTimeKey(), nowTime);
      setVal(rewardsClickTimeKey, 0);
      setVal(rewardsLastPointsKey, -1);
      setVal(rewardsFailCountKey, 0);

      setTimeout(() => {
          window.location.href = "https://rewards.bing.com/";
      }, 1000);
      return;
  }

  // 2. æœç´¢åˆ·åˆ†ä¸»é€»è¾‘
  let currentPoints = getBingPoints();
  if (currentPoints === null) {
      if (document.readyState === 'complete') { currentPoints = 0; }
      else { return; }
  }

  // æœç´¢å†·å´æ—¶é—´æ£€æŸ¥ (åŸºäºæœ¬åœ°æ—¶é—´ï¼Œé˜²æ­¢åˆ·å¤ªå¿«)
  let jobLockExpires = getVal(autoSearchLockExpiresKey, "");
  let now = new Date();

  if (jobLockExpires) {
      let expireTime = new Date(jobLockExpires);
      if (expireTime > now) {
          let secondsLeft = Math.ceil((expireTime - now) / 1000);
          showUserMessage(`ç­‰å¾…å†·å´ ${secondsLeft}s | å½“å‰ç§¯åˆ†: ${currentPoints}`);
          return;
      }
  }

  let lastPoints = getVal(lastPointsKey, null);
  let currentSearchCount = Number(getVal(getAutoSearchCountKey(), 0));
  let isPointsIncreased = false;

  let maxNoGainLimit = Number(getVal(maxNoGainLimitKey, 10));
  let consecutiveNoGain = Number(getVal(consecutiveNoGainKey, 0));

  // ç§¯åˆ†å¯¹æ¯”
  if (lastPoints !== null) {
      let lastP = Number(lastPoints);
      if (currentPoints > lastP) {
          currentSearchCount++;
          setVal(getAutoSearchCountKey(), currentSearchCount);
          isPointsIncreased = true;
          setVal(consecutiveNoGainKey, 0);

          // ã€ä¿®å¤ã€‘ç§¯åˆ†æ¶¨äº†ï¼Œè¯´æ˜å½“å‰é¡µé¢æ­£å¸¸ï¼Œé‡ç½®â€œæ¢é¡µé‡è¯•è®¡æ•°â€
          setVal(relayRetryKey, 0);

          console.log(`[Rebang] Points increased: ${lastP} -> ${currentPoints}.`);
      } else {
          consecutiveNoGain++;
          setVal(consecutiveNoGainKey, consecutiveNoGain);

          // è¿ç»­æ— ç§¯åˆ†ä¿æŠ¤é€»è¾‘
          if (consecutiveNoGain >= maxNoGainLimit) {
              // è·å–å·²å°è¯•æ¢é¡µçš„æ¬¡æ•°
              let retryCount = Number(getVal(`${prefix}RelayRetryCount`, 0)); // ä½¿ç”¨åŠ¨æ€å˜é‡åæˆ–ç›´æ¥å†™æ­» key å­—ç¬¦ä¸²

              // ã€ä¿®å¤é€»è¾‘ã€‘ä»…å…è®¸å°è¯•æ¢é¡µ 1 æ¬¡
              if (retryCount < 1) {
                  console.log("[Rebang] è¿ç»­æ— åˆ†ï¼Œå°è¯•æ–°å»ºæ ‡ç­¾é¡µæ¿€æ´»...");

                  setVal(`${prefix}RelayRetryCount`, retryCount + 1); // å¢åŠ é‡è¯•è®¡æ•°
                  setVal(consecutiveNoGainKey, 0); // é‡è¦ï¼šå½’é›¶æ— åˆ†è®¡æ•°ï¼Œè®©æ–°é¡µé¢ä»0å¼€å§‹è®¡ç®—

                  openNewWorkerTab(); // æ‰§è¡Œç§»äº¤
                  return; // é€€å‡ºå½“å‰é¡µé¢çš„æ‰§è¡Œå¾ªç¯
              }
              // å¦‚æœå·²ç»æ¢è¿‡ä¸€æ¬¡é¡µäº†ï¼Œè¿˜æ˜¯æ— åˆ†ï¼Œè¯´æ˜æ˜¯çœŸæ²¡åˆ†äº†ï¼Œåœæ­¢ã€‚
              else {
                  setVal(`${prefix}RelayRetryCount`, 0); // é‡ç½®ä»¥ä¾¿ä¸‹æ¬¡æ‰‹åŠ¨å¼€å§‹
                  stopAutoSearch(`å·²å°è¯•æ¢é¡µä½†ä»è¿ç»­${maxNoGainLimit}æ¬¡æ— ç§¯åˆ†ï¼Œåˆ¤å®šä¸ºä»Šæ—¥è¾¾èµ«æˆ–IPé™åˆ¶ã€‚`);
                  return;
              }
          }
      }
  }

  $("#ext-current-count").text(currentSearchCount);

  // æ¯æ—¥æœç´¢æ¬¡æ•°é™åˆ¶
  let limitSearchCount = Number(getVal(limitSearchCountKey, 50));
  if (currentSearchCount >= limitSearchCount) {
      setVal(lastPointsKey, null);
      stopAutoSearch("ä»Šæ—¥ç§¯åˆ†ä»»åŠ¡å·²è¾¾æ ‡ï¼");
      return;
  }

  // --- ç¡®è®¤ä¸ºæœ‰æ•ˆæœç´¢ï¼Œæ›´æ–°å…¨å±€é” (æ ¸å¿ƒ) ---
  // è¿™ä¼šå‘Šè¯‰å…¶ä»–æ ‡ç­¾é¡µï¼š"æˆ‘åˆšæœè¿‡ï¼Œä½ ä»¬æ­‡ç€"
  setVal(globalLockKey, Date.now());
  setVal(globalMasterTabKey, currentTabId);
  // -------------------------------------

  // è®¾ç½®ä¸‹æ¬¡æœç´¢çš„éšæœºå»¶è¿Ÿ (8-14ç§’)
  let randomDelay = Math.floor(Math.random() * 6000) + 8000;
  let t = new Date();
  t.setSeconds(t.getSeconds() + randomDelay / 1000);
  setVal(autoSearchLockExpiresKey, t.toString());

  // è·å–å…³é”®è¯å¹¶æ‰§è¡Œæœç´¢
  let currentKeywordIndex = Number(localStorage.getItem(currentKeywordIndexKey) ?? 0);
  var cacheKey = getCurrentChannelKeywordsCacheKey();
  var keywords = JSON.parse(sessionStorage.getItem(cacheKey));

  if (keywords && keywords.length > currentKeywordIndex) {
    setVal(lastPointsKey, currentPoints);

    currentKeywordIndex++;
    localStorage.setItem(currentKeywordIndexKey, currentKeywordIndex);

    let msg = isPointsIncreased ? `ç§¯åˆ†+${currentPoints - Number(lastPoints)}! ` : (lastPoints !== null ? `æ— åˆ†(${consecutiveNoGain}/${maxNoGainLimit}). ` : "");
    showUserMessage(`${msg}æœç´¢: ${truncateText(keywords[currentKeywordIndex - 1].title, 15)}`);

    doSearch(keywords[currentKeywordIndex - 1].title);
  } else {
    // å¦‚æœæ²¡æœ‰å…³é”®è¯æˆ–æœå®Œäº†
    if (!keywords) {
        initKeywords();
    } else {
        switchToNextChannel();
    }
  }
}

// åˆå§‹åŒ–æ¦œå•ä¸‹æ‹‰æ¡†
function initChannels(channels, selectedChannel) {
  $("#ext-channels").empty();
  channels?.forEach(function (element) {
    var opt = new Option(element, element);
    opt.selected = element == selectedChannel;
    $("#ext-channels").append(opt);
  });
  if (localStorage.getItem(selectedChannelKey) == null) {
    localStorage.setItem(selectedChannelKey, "å¾®åš");
  }
  initKeywords();
}

// åˆå§‹åŒ–/è·å–å…³é”®è¯ (ä» API)
function initKeywords() {
  var cacheKey = getCurrentChannelKeywordsCacheKey();
  var keywords = sessionStorage.getItem(cacheKey);
  if (keywords) {
    renderKeywords(JSON.parse(keywords));
  } else {
    showUserMessage("æ­£åœ¨åŠ è½½æ¦œå•...");
    $.ajax({
      url: "https://api.pearktrue.cn/api/dailyhot/?title=" + getCurrentChannel(),
      method: "GET",
      timeout: 0,
    }).done(function (response) {
      if (response.code == 200 && response.data) {
        keywords = response.data;
        sessionStorage.setItem(cacheKey, JSON.stringify(keywords));
        renderKeywords(keywords);
        showUserMessage("");
      } else {
        showUserMessage(`è·å–çƒ­æ¦œå¤±è´¥ï¼Œè¯·é‡è¯•ã€‚`);
      }
    });
  }
}

// æ¸²æŸ“å…³é”®è¯åˆ—è¡¨åˆ°æ‚¬æµ®çª—
function renderKeywords(keywords) {
  $("#ext-keywords-list").empty();
  let currentIndex = Number(localStorage.getItem(currentKeywordIndexKey) ?? 0);

  keywords.forEach(function (element, index) {
    let activeClass = (index + 1 === currentIndex) ? "keyword-link-current" : "";
    let linkHtml = "";
    if ($("#ext-keywords-linktype").val() == "æœç´¢") {
        linkHtml = `<a target='_self' class='keyword-link keyword-link-search ${activeClass}' title='${element.title}' href='javascript:void();'>${index + 1}. ${truncateText(element.title, 20)}</a>`;
    } else {
        linkHtml = `<a target='_blank' class='keyword-link ${activeClass}' title='${element.title}' href='${element.url ?? element.mobileUrl}'>${index + 1}. ${truncateText(element.title, 20)}</a>`;
    }
    $("#ext-keywords-list").append(linkHtml);
  });
  $("#ext-keywords-list").append(`<a target='_blank' class='keyword-link' style='color:#0078d4;margin-top:5px;' href='https://rewards.bing.com/welcome?rh=4F42E699&ref=rafsrchae&form=ML2XE3&OCID=ML2XE3&PUBL=RewardsDO&CREA=ML2XE3'>ğŸ‘‰ Rewards èµšç§¯åˆ† ğŸ‘ˆ</a>`);
  $("#ext-keywords-list .keyword-link-search").click(function (e) { doSearch($(this).attr("title")); });
}

// æ¢å¤æ‚¬æµ®çª—ä½ç½®
function restoreWidgetPosition() {
    const pos = JSON.parse(localStorage.getItem(widgetPosKey));
    if (pos) { $("#rebang-widget").css({ top: pos.top, left: pos.left, right: 'auto', bottom: 'auto' }); }
    else { $("#rebang-widget").css({ top: '100px', right: '20px' }); }

    const isMinimized = localStorage.getItem(widgetStateKey) === 'true';
    if (isMinimized) { $("#rebang-body").addClass("minimized"); $("#rebang-toggle-icon").text("+"); }
    else { $("#rebang-toggle-icon").text("âˆ’
